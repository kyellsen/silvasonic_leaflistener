============================= test session starts ==============================
platform linux -- Python 3.14.2, pytest-9.0.2, pluggy-1.6.0
rootdir: /mnt/data/dev/packages/silvasonic_leaflistener/containers/birdnet
configfile: pyproject.toml
testpaths: tests
plugins: mock-3.15.1, cov-7.0.0
collected 19 items

tests/test_analyzer.py ........                                          [ 42%]
tests/test_config.py FF                                                  [ 52%]
tests/test_database.py ...                                               [ 68%]
tests/test_main.py .                                                     [ 73%]
tests/test_watcher.py ...

=================================== FAILURES ===================================
_____________________________ test_config_defaults _____________________________

    def test_config_defaults():
        """Test that config loads with expected defaults when no env vars are set."""
        # We need to ensure we are testing a clean state.
        # Since config is a module-level instance, we must reload it with a clean environment.
        with patch.dict(os.environ, {}, clear=True):
            importlib.reload(src.config)
            assert str(src.config.config.DB_PATH) == "/data/db/birdnet.sqlite"
>           assert str(src.config.config.INPUT_DIR) == "/data/input"
E           AssertionError: assert '/data/recording' == '/data/input'
E             
E             - /data/input
E             + /data/recording

tests/test_config.py:14: AssertionError
____________________________ test_config_overrides _____________________________

    def test_config_overrides():
        """Test that environment variables correctly override defaults."""
        env_vars = {
            "DB_PATH": "/tmp/custom.sqlite",
            "INPUT_DIR": "/tmp/custom_input",
            "LATITUDE": "10.0",
            "LONGITUDE": "20.0",
            "MIN_CONFIDENCE": "0.5",
            "SIG_OVERLAP": "1.5",
            "SIG_LENGTH": "5.0",
            "THREADS": "4",
            "RECURSIVE_WATCH": "true"
        }
    
        with patch.dict(os.environ, env_vars, clear=True):
            importlib.reload(src.config)
            assert str(src.config.config.DB_PATH) == "/tmp/custom.sqlite"
            assert str(src.config.config.INPUT_DIR) == "/tmp/custom_input"
            assert src.config.config.LATITUDE == 10.0
            assert src.config.config.LONGITUDE == 20.0
            assert src.config.config.MIN_CONFIDENCE == 0.5
>           assert src.config.config.SIG_OVERLAP == 1.5
E           AssertionError: assert 0.0 == 1.5
E            +  where 0.0 = <src.config.Config object at 0x7fe8abc5e660>.SIG_OVERLAP
E            +    where <src.config.Config object at 0x7fe8abc5e660> = <module 'src.config' from '/mnt/data/dev/packages/silvasonic_leaflistener/containers/birdnet/src/config.py'>.config
E            +      where <module 'src.config' from '/mnt/data/dev/packages/silvasonic_leaflistener/containers/birdnet/src/config.py'> = src.config

tests/test_config.py:44: AssertionError
=============================== warnings summary ===============================
tests/test_analyzer.py::TestProcessFile::test_process_file_success
tests/test_analyzer.py::TestProcessFile::test_save_detections_various_formats
tests/test_analyzer.py::TestProcessFile::test_save_detections_various_formats
tests/test_database.py::test_detection_model
  /mnt/data/dev/packages/silvasonic_leaflistener/containers/birdnet/.venv/lib64/python3.14/site-packages/sqlalchemy/sql/schema.py:3624: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    return util.wrap_callable(lambda ctx: fn(), fn)  # type: ignore

tests/test_analyzer.py::TestProcessFile::test_process_file_exception_handling
tests/test_analyzer.py::TestProcessFile::test_process_file_save_error
  /mnt/data/dev/packages/silvasonic_leaflistener/containers/birdnet/src/analyzer.py:38: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    recording_dt = datetime.datetime.utcnow()

tests/test_analyzer.py::TestProcessFile::test_save_detections_various_formats
  /mnt/data/dev/packages/silvasonic_leaflistener/containers/birdnet/tests/test_analyzer.py:98: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    analyzer._save_detections(detections_dict, "file.wav", datetime.datetime.utcnow())

tests/test_analyzer.py::TestProcessFile::test_save_detections_various_formats
  /mnt/data/dev/packages/silvasonic_leaflistener/containers/birdnet/tests/test_analyzer.py:107: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    analyzer._save_detections(detections_tuple, "file.wav", datetime.datetime.utcnow())

tests/test_database.py::test_detection_model
  /mnt/data/dev/packages/silvasonic_leaflistener/containers/birdnet/tests/test_database.py:8: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    recording_timestamp=datetime.utcnow(),

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED tests/test_config.py::test_config_defaults - AssertionError: assert '/...
FAILED tests/test_config.py::test_config_overrides - AssertionError: assert 0...
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! KeyboardInterrupt !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
/usr/lib64/python3.14/unittest/mock.py:1238: KeyboardInterrupt
(to show a full traceback on KeyboardInterrupt use --full-trace)
=================== 2 failed, 15 passed, 9 warnings in 0.22s ===================
