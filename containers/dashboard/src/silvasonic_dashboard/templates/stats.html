{% extends base %} {% block content %}
<div class="space-y-8">
  <!-- Header -->
  <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
    <div>
      <h1
        class="text-3xl font-bold bg-gradient-to-r from-indigo-400 to-violet-500 bg-clip-text text-transparent"
      >
        BirdStats
      </h1>
      <p class="text-gray-400 mt-1">Ecological Analytics & Insights</p>
    </div>

    <!-- Date Filter Controls -->
    <form
      action="/stats"
      method="get"
      class="flex flex-col sm:flex-row gap-2 bg-white dark:bg-gray-800 p-2 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700"
      hx-target="#main-content"
      hx-swap="innerHTML"
      hx-push-url="true"
      x-data="birdStats({
          daily: {{ stats.daily | tojson }},
          hourly: {{ stats.hourly | tojson }},
          topSpecies: {{ stats.top_species | tojson }},
          isDark: document.documentElement.classList.contains('dark')
      })"
      x-init="init()"
    >
      <input
        type="date"
        name="start"
        value="{{ stats.period.start }}"
        class="bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-2 text-sm text-gray-700 dark:text-gray-300 focus:ring-2 focus:ring-indigo-500 outline-none"
        aria-label="Start Date"
      />
      <span class="hidden sm:flex items-center text-gray-400">-</span>
      <input
        type="date"
        name="end"
        value="{{ stats.period.end }}"
        class="bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-2 text-sm text-gray-700 dark:text-gray-300 focus:ring-2 focus:ring-indigo-500 outline-none"
        aria-label="End Date"
      />
      <button
        type="submit"
        class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition"
      >
        Update
      </button>
    </form>
  </div>

  <!-- Time Series Section -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Main Activity Chart -->
    <div class="col-span-1 lg:col-span-2 silva-card p-6">
      <div class="flex items-center justify-between mb-6">
        <h3
          class="text-lg font-bold text-gray-900 dark:text-white flex items-center gap-2"
        >
          <svg
            class="w-5 h-5 text-indigo-400"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"
            ></path>
          </svg>
          Activity Trend
        </h3>
      </div>
      <div class="h-80 w-full relative">
        <div id="dailyChart" class="w-full h-full"></div>
      </div>
    </div>

    <!-- Hourly Distribution -->
    <div class="silva-card p-6">
      <h3
        class="text-lg font-bold text-gray-900 dark:text-white mb-6 flex items-center gap-2"
      >
        <svg
          class="w-5 h-5 text-amber-400"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
          ></path>
        </svg>
        Peak Hours
      </h3>
      <div class="h-80 w-full relative">
        <div id="hourlyChart" class="w-full h-full"></div>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Top Species (Bar) -->
    <div class="silva-card p-6">
      <div class="flex items-center justify-between mb-6">
        <h3
          class="text-lg font-bold text-gray-900 dark:text-white flex items-center gap-2"
        >
          <svg
            class="w-5 h-5 text-purple-400"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
            ></path>
          </svg>
          Top Species in Period
        </h3>
      </div>
      <div class="h-80 w-full relative">
        <div id="topSpeciesChart" class="w-full h-full"></div>
      </div>
    </div>

    <!-- Rarest Species List -->
    <div class="silva-card p-6 flex flex-col">
      <h3
        class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2"
      >
        <svg
          class="w-5 h-5 text-emerald-400"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"
          ></path>
        </svg>
        Rare Sightings (Least Frequent)
      </h3>
      <div class="overflow-x-auto flex-1">
        <table
          class="w-full text-left text-sm text-gray-600 dark:text-gray-400"
        >
          <thead
            class="bg-gray-100 dark:bg-gray-700/50 text-xs uppercase font-medium text-gray-500 dark:text-gray-300"
          >
            <tr>
              <th class="px-4 py-3 rounded-l-lg">Species</th>
              <th class="px-4 py-3">Count</th>
              <th class="px-4 py-3 rounded-r-lg text-right">Action</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200 dark:divide-gray-700/50">
            {% for bird in stats.rarest %}
            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/30 transition">
              <td class="px-4 py-3 font-medium text-gray-900 dark:text-white">
                {{ bird.common_name }}
              </td>
              <td class="px-4 py-3">
                <span
                  class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 border border-gray-200 dark:border-gray-600"
                >
                  {{ bird.count }}
                </span>
              </td>
              <td class="px-4 py-3 text-right">
                <a
                  href="/birdnet/discover/{{ bird.common_name }}"
                  hx-target="#main-content"
                  hx-swap="innerHTML"
                  hx-push-url="true"
                  class="text-blue-400 hover:text-blue-300 text-xs font-medium"
                  >Analyze &rarr;</a
                >
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="3" class="px-4 py-8 text-center text-gray-500">
                No rare species data available for this period.
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  document.addEventListener("alpine:init", () => {
    Alpine.data("birdStats", (data) => ({
      daily: data.daily || [],
      hourly: data.hourly || [],
      topSpecies: data.topSpecies || { labels: [], values: [] },
      isDark: data.isDark,
      charts: {},

      init() {
        this.$nextTick(() => {
          this.renderDailyChart();
          this.renderHourlyChart();
          this.renderTopSpeciesChart();
        });

        // Theme Observer
        const observer = new MutationObserver((mutations) => {
          const newDark = document.documentElement.classList.contains("dark");
          if (this.isDark !== newDark) {
            this.isDark = newDark;
            this.updateTheme();
          }
        });
        observer.observe(document.documentElement, {
          attributes: true,
          attributeFilter: ["class"],
        });
      },

      getChartConfig(type) {
        const textColor = this.isDark ? "#9ca3af" : "#4b5563";
        const gridColor = this.isDark ? "#374151" : "#e5e7eb";
        const fontFamily = "Inter, sans-serif";

        return {
          chart: {
            type: type,
            background: "transparent",
            toolbar: { show: false },
            animations: { enabled: true },
            height: "100%",
            parentHeightOffset: 0,
          },
          theme: { mode: this.isDark ? "dark" : "light" },
          dataLabels: { enabled: false },
          grid: { borderColor: gridColor, strokeDashArray: 4 },
          xaxis: {
            labels: { style: { colors: textColor, fontFamily: fontFamily } },
            axisBorder: { show: false },
            axisTicks: { show: false },
          },
          yaxis: {
            labels: { style: { colors: textColor, fontFamily: fontFamily } },
          },
          tooltip: { theme: this.isDark ? "dark" : "light" },
        };
      },

      renderDailyChart() {
        if (!document.getElementById("dailyChart")) return;
        if (this.daily.length === 0) {
          document.getElementById("dailyChart").innerHTML =
            "<div class='flex h-full items-center justify-center text-gray-500'>No data</div>";
          return;
        }

        const options = {
          ...this.getChartConfig("area"),
          series: [{ name: "Detections", data: this.daily }],
          stroke: { curve: "smooth", width: 2 },
          fill: {
            type: "gradient",
            gradient: {
              shadeIntensity: 1,
              opacityFrom: 0.7,
              opacityTo: 0.2,
              stops: [0, 90, 100],
            },
          },
          colors: ["#6366f1"],
          xaxis: {
            ...this.getChartConfig("area").xaxis,
            type: "datetime",
          },
        };

        this.charts.daily = new ApexCharts(
          document.getElementById("dailyChart"),
          options,
        );
        this.charts.daily.render();
      },

      renderHourlyChart() {
        if (!document.getElementById("hourlyChart")) return;
        const categories = Array.from({ length: 24 }, (_, i) => i + ":00");

        const options = {
          ...this.getChartConfig("bar"),
          series: [{ name: "Count", data: this.hourly }],
          colors: ["#f59e0b"],
          xaxis: {
            ...this.getChartConfig("bar").xaxis,
            categories: categories,
          },
          plotOptions: { bar: { borderRadius: 4, columnWidth: "60%" } },
        };

        this.charts.hourly = new ApexCharts(
          document.getElementById("hourlyChart"),
          options,
        );
        this.charts.hourly.render();
      },

      renderTopSpeciesChart() {
        if (!document.getElementById("topSpeciesChart")) return;
        if (this.topSpecies.labels.length === 0) {
          document.getElementById("topSpeciesChart").innerHTML =
            "<div class='flex h-full items-center justify-center text-gray-500'>No data</div>";
          return;
        }

        const options = {
          ...this.getChartConfig("bar"),
          chart: {
            ...this.getChartConfig("bar").chart,
            events: {
              dataPointSelection: (event, chartContext, config) => {
                const label =
                  config.w.config.xaxis.categories[config.dataPointIndex];
                if (label)
                  window.location.href = `/birdnet/discover/${encodeURIComponent(label)}`;
              },
            },
          },
          series: [{ name: "Detections", data: this.topSpecies.values }],
          colors: ["#a855f7"],
          xaxis: {
            ...this.getChartConfig("bar").xaxis,
            categories: this.topSpecies.labels,
          },
          plotOptions: {
            bar: { borderRadius: 4, horizontal: true, barHeight: "50%" },
          },
        };

        this.charts.top = new ApexCharts(
          document.getElementById("topSpeciesChart"),
          options,
        );
        this.charts.top.render();
      },

      updateTheme() {
        const newMode = this.isDark ? "dark" : "light";
        const textColor = this.isDark ? "#9ca3af" : "#4b5563";
        const gridColor = this.isDark ? "#374151" : "#e5e7eb";

        const commonUpdate = {
          theme: { mode: newMode },
          grid: { borderColor: gridColor },
          xaxis: { labels: { style: { colors: textColor } } },
          yaxis: { labels: { style: { colors: textColor } } },
          tooltip: { theme: newMode },
        };

        Object.values(this.charts).forEach((chart) => {
          chart.updateOptions(commonUpdate);
        });
      },
    }));
  });
</script>
{% endblock %} {% block inspector %}
<div id="inspector-content" hx-swap-oob="innerHTML:#inspector-content">
  <div class="space-y-6">
    <!-- Data Export -->
    <div class="silva-card p-6">
      <h3
        class="font-bold text-gray-900 dark:text-white mb-4 border-b border-gray-200 dark:border-white/10 pb-2 text-sm uppercase tracking-wide"
      >
        Data Export
      </h3>
      <a
        href="/api/export/birdnet/csv"
        download="birdnet_export.csv"
        hx-boost="false"
        class="flex items-center justify-center gap-2 w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl transition shadow-lg font-medium text-sm"
      >
        <svg
          class="w-4 h-4"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
          ></path>
        </svg>
        Download Full CSV
      </a>
      <p class="text-xs text-center text-gray-500 mt-2">
        Includes all historical detections.
      </p>
    </div>

    <!-- Metric Definitions -->
    <div class="glass-panel p-6 rounded-2xl">
      <h3
        class="font-bold text-gray-900 dark:text-white mb-4 border-b border-gray-200 dark:border-white/10 pb-2 text-sm uppercase tracking-wide"
      >
        Metric Guide
      </h3>
      <div class="space-y-4 text-xs text-gray-600 dark:text-gray-300">
        <div>
          <strong class="text-gray-900 dark:text-white block mb-1"
            >Activity Trend</strong
          >
          <p>Number of detections per day over the selected period.</p>
        </div>
        <div>
          <strong class="text-gray-900 dark:text-white block mb-1"
            >Peak Hours</strong
          >
          <p>
            Accumulated detections by hour of day (0-23h) for the selected
            period.
          </p>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
