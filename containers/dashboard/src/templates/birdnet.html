{% extends base %} {% block content %}
<h2 class="text-2xl font-bold mb-6 text-silva-800 dark:text-silva-100">
  BirdNET Detections
</h2>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
  <!-- Stats Panel -->
  <div
    class="bg-white dark:bg-gray-800 p-6 rounded-xl border border-gray-200 dark:border-gray-700"
  >
    <h3 class="font-bold text-gray-400 uppercase text-xs mb-4">
      Top Species (All Time)
    </h3>
    <div class="space-y-3">
      {% for s in stats.top_species %}
      <div class="flex items-center justify-between">
        <span class="font-bold text-gray-900 dark:text-white text-base block"
          >{{ s.display_name }}</span
        >
        <span
          class="bg-gray-100 dark:bg-gray-700 text-green-600 dark:text-green-400 px-2 py-1 rounded text-xs"
          >{{ s.count }}</span
        >
      </div>
      <div
        class="w-full bg-gray-200 dark:bg-gray-700 h-1 rounded-full overflow-hidden"
      >
        <div
          class="bg-green-500 h-full"
          style="width: {{ (s.count / stats.total * 100)|round }}%"
        ></div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

<div
  class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden"
>
  <table class="w-full text-left text-sm">
    <thead
      class="bg-gray-100 dark:bg-gray-750 text-gray-500 dark:text-gray-400 uppercase font-bold text-xs"
    >
      <tr>
        <th class="p-4">Date</th>
        <th class="p-4">Time</th>
        <th class="p-4">Species</th>
        <th class="p-4">Conf</th>
        <th class="p-4">Play</th>
      </tr>
    </thead>
    <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
      {% for d in detections %}
      <tr
        class="group hover:bg-silva-50/50 dark:hover:bg-gray-700/50 transition border-l-2 border-transparent hover:border-silva-500 cursor-pointer"
        onclick="
          if (!event.target.closest('button'))
            htmx.trigger(this.querySelector('.details-btn'), 'click');
        "
      >
        <td class="p-4 text-gray-400">
          <span
            class="local-date opacity-70 group-hover:opacity-100 transition-opacity font-mono text-xs"
            data-timestamp="{{ d.iso_timestamp }}"
            >...</span
          >
        </td>
        <td class="p-4 font-mono text-gray-400">
          <span
            class="local-time-only opacity-70 group-hover:opacity-100 transition-opacity font-mono text-xs"
            data-timestamp="{{ d.iso_timestamp }}"
            >...</span
          >
        </td>
        <td class="p-4">
          <div class="font-bold text-gray-900 dark:text-gray-100">
            {{ d.display_name }}
          </div>
          <div class="text-xs text-gray-500 italic">{{ d.sci_name }}</div>
        </td>
        <td class="p-4">
          <div class="flex items-center gap-2">
            <div
              class="w-16 h-1.5 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden"
            >
              <div
                class="h-full bg-gradient-to-r from-silva-400 to-silva-600"
                style="width: {{ d.confidence * 100 }}%"
              ></div>
            </div>
            <span
              class="text-xs font-medium text-gray-600 dark:text-gray-400 w-8"
              >{{ (d.confidence * 100)|int }}%</span
            >
          </div>
        </td>
        <td class="p-4 flex items-center gap-2">
          <!-- Play Button -->
          <button
            class="p-2 rounded-full hover:bg-silva-100 dark:hover:bg-gray-600 text-silva-600 dark:text-silva-400 transition"
            onclick="event.stopPropagation(); playGlobalAudio('{{ d.filename }}', '{{ d.display_name }}', '{{ d.confidence }}')"
            title="Play Audio"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"
              ></path>
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
              ></path>
            </svg>
          </button>

          <!-- Details Trigger (Hidden/Visible) -->
          <button
            class="details-btn p-2 rounded-full hover:bg-blue-50 dark:hover:bg-gray-600 text-blue-500 dark:text-blue-400 transition opacity-0 group-hover:opacity-100"
            hx-get="/api/details/birdnet/{{ d.filename }}"
            hx-target="#inspector-content"
            hx-swap="innerHTML"
            onclick="ensureInspectorOpen()"
            title="View Details"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
              />
            </svg>
          </button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
  function ensureInspectorOpen() {
    const sidebar = document.getElementById("right-sidebar");
    // Check if collapsed (w-0 class presence)
    if (sidebar.classList.contains("w-0")) {
      toggleInspector();
    }
  }
</script>
{% endblock %} {% block inspector %}
<!-- Default Inspector Content for this page -->
<div class="p-4 space-y-6">
  <div
    class="bg-white dark:bg-gray-700/50 p-4 rounded-lg border border-gray-200 dark:border-transparent"
  >
    <h3
      class="font-bold text-gray-700 dark:text-gray-300 mb-2 border-b border-gray-200 dark:border-gray-600 pb-2"
    >
      Quick Stats
    </h3>
    <div class="flex justify-between text-sm py-1">
      <span class="text-gray-400">Today</span>
      <span class="font-bold text-gray-900 dark:text-white"
        >{{ stats.today if stats else '0' }}</span
      >
    </div>
    <div class="flex justify-between text-sm py-1">
      <span class="text-gray-400">Total</span>
      <span class="font-bold text-gray-900 dark:text-white"
        >{{ stats.total if stats else '0' }}</span
      >
    </div>
  </div>

  <div
    class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700 mt-4"
  >
    <h3 class="font-bold text-gray-400 uppercase text-xs mb-4">Filter</h3>
    <input
      type="text"
      placeholder="Search..."
      class="w-full bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded p-2 text-sm text-gray-900 dark:text-white"
    />
  </div>
</div>
{% endblock %}
