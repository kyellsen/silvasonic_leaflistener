{% extends base %} {% block content %}
<h2
  class="text-xl font-bold mb-4 text-purple-600 dark:text-purple-400 flex items-center gap-2"
>
  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path
      stroke-linecap="round"
      stroke-linejoin="round"
      stroke-width="2"
      d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"
    ></path>
  </svg>
  Livesound Stream
</h2>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
  <!-- Main Player Card -->
  <div
    class="lg:col-span-2 bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700 overflow-hidden"
  >
    <div class="p-6">
      <h3 class="font-bold text-lg text-gray-700 dark:text-gray-300 mb-4">
        Live Audio & Spectrogram
      </h3>

      <!-- Audio Player -->
      <div
        class="mb-6 bg-gray-100 dark:bg-gray-900 rounded-lg p-4 flex items-center justify-between"
      >
        <div class="flex items-center gap-4">
          <button
            id="playButton"
            class="w-12 h-12 flex items-center justify-center rounded-full bg-purple-600 hover:bg-purple-700 text-white transition-colors"
          >
            <svg
              class="w-6 h-6"
              fill="currentColor"
              viewBox="0 0 24 24"
              id="playIcon"
            >
              <path d="M8 5v14l11-7z" />
            </svg>
            <svg
              class="w-6 h-6 hidden"
              fill="currentColor"
              viewBox="0 0 24 24"
              id="pauseIcon"
            >
              <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z" />
            </svg>
          </button>
          <div>
            <div class="text-sm font-bold text-gray-900 dark:text-gray-100">
              Live Stream
            </div>
            <div class="text-xs text-green-500 font-mono" id="statusText">
              Connecting...
            </div>
          </div>
        </div>

        <div class="text-xs text-gray-400">
          Host: <span class="font-mono">port 8000</span>
        </div>
      </div>

      <!-- Spectrogram Canvas -->
      <div
        class="relative w-full h-64 bg-black rounded-lg overflow-hidden ring-1 ring-gray-900/5"
      >
        <canvas id="spectrogramCanvas" class="w-full h-full"></canvas>
        <div
          class="absolute top-2 right-2 text-xs text-white/50 bg-black/50 px-2 py-1 rounded"
        >
          Live FFT
        </div>
      </div>
    </div>
  </div>

  <!-- Info / Controls -->
  <div
    class="bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700 p-6"
  >
    <h3 class="font-bold text-lg text-gray-700 dark:text-gray-300 mb-4">
      Stream Info
    </h3>

    <div class="space-y-4">
      <div
        class="flex justify-between items-center py-2 border-b border-gray-100 dark:border-gray-700"
      >
        <span class="text-sm text-gray-500">Status</span>
        <span
          class="px-2 py-1 rounded text-xs font-bold bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200"
          id="connectionStatus"
        >
          Online
        </span>
      </div>
      <div
        class="flex justify-between items-center py-2 border-b border-gray-100 dark:border-gray-700"
      >
        <span class="text-sm text-gray-500">Latency</span>
        <span class="text-sm font-mono text-gray-700 dark:text-gray-300"
          >~200ms</span
        >
      </div>
      <div
        class="flex justify-between items-center py-2 border-b border-gray-100 dark:border-gray-700"
      >
        <span class="text-sm text-gray-500">Sample Rate</span>
        <span class="text-sm font-mono text-gray-700 dark:text-gray-300"
          >44.1 kHz</span
        >
      </div>

      <div class="mt-6 pt-4">
        <div class="text-xs text-gray-400 mb-2">Volume</div>
        <input
          type="range"
          id="volumeSlider"
          min="0"
          max="1"
          step="0.1"
          value="1"
          class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700"
        />
      </div>
    </div>
  </div>
</div>

  /* 
   * Livesound Lifecycle Management 
   * Handles initialization and cleanup for HTMX navigation
   */
  (function() {
    // --- State ---
    const state = {
      audioCtx: null,
      audioEl: new Audio(),
      ws: null,
      wsUrl: `ws://${window.location.hostname}:8000/ws/spectrogram`,
      streamUrl: `http://${window.location.hostname}:8000/stream`,
      canvas: document.getElementById("spectrogramCanvas"),
      ctx: null,
      tempCanvas: document.createElement("canvas"),
      tempCtx: null,
      maxReconnects: 5,
      reconnectCount: 0,
      isActive: true // Flag to stop loops if we navigate away
    };

    // --- DOM Elements ---
    const ui = {
      playBtn: document.getElementById("playButton"),
      playIcon: document.getElementById("playIcon"),
      pauseIcon: document.getElementById("pauseIcon"),
      status: document.getElementById("statusText"),
      vol: document.getElementById("volumeSlider"),
      connStatus: document.getElementById("connectionStatus")
    };

    // --- Initialization ---
    function init() {
      // Setup Audio Element
      state.audioEl.crossOrigin = "anonymous";
      
      // Setup Canvas
      if (state.canvas) {
        state.ctx = state.canvas.getContext("2d");
        state.tempCtx = state.tempCanvas.getContext("2d");
        resizeCanvas();
        window.addEventListener("resize", resizeCanvas);
      }

      // Setup Listeners
      setupAudioListeners();
      setupUIListeners();
      
      // Auto-connect WS
      connectWebSocket();

      // Register Cleanup for HTMX
      // This listener will fire when HTMX is about to swap OUT the content
      document.body.addEventListener('htmx:beforeSwap', cleanup, { once: true });
    }

    // --- Cleanup ---
    function cleanup(event) {
      console.log("[Livesound] Cleaning up resources...");
      state.isActive = false;

      // 1. Stop Audio
      if (state.audioEl) {
        state.audioEl.pause();
        state.audioEl.src = "";
        state.audioEl.load();
        state.audioEl = null;
      }

      // 2. Close WebSocket
      if (state.ws) {
        state.ws.onclose = null; // Prevent reconnect loops
        state.ws.close();
        state.ws = null;
      }

      // 3. Remove Global Listeners
      window.removeEventListener("resize", resizeCanvas);
      
      // Note: Event listeners on DOM elements (playBtn) are removed automatically 
      // when the elements are removed from the DOM by HTMX.
    }

    // --- WebSocket Logic ---
    function connectWebSocket() {
      if (!state.isActive) return;

      state.ws = new WebSocket(state.wsUrl);

      state.ws.onopen = () => {
        ui.status.innerText = "Connected";
        ui.status.className = "text-xs text-green-500 font-mono";
        ui.connStatus.innerText = "Real-time";
        state.reconnectCount = 0;
      };

      state.ws.onmessage = (event) => {
        if (!state.isActive) return;
        const msg = JSON.parse(event.data);
        if (msg.type === "spectrogram") {
          drawSpectrogramColumn(msg.data);
        }
      };

      state.ws.onclose = () => {
        if (!state.isActive) return;
        ui.status.innerText = "Disconnected";
        ui.status.className = "text-xs text-red-500 font-mono";
        
        if (state.reconnectCount < state.maxReconnects) {
          state.reconnectCount++;
          setTimeout(connectWebSocket, 2000);
        }
      };
    }

    // --- Audio Control ---
    function startStream() {
      ui.status.innerText = "Connecting Audio...";
      // Cache buster to force new stream
      state.audioEl.src = `${state.streamUrl}?t=${Date.now()}`;
      state.audioEl.play().catch(e => {
        console.error("Play failed:", e);
        ui.status.innerText = "Stream Error";
      });
    }

    function stopStream() {
      state.audioEl.pause();
      state.audioEl.src = "";
      state.audioEl.load();
    }

    // --- Spectrogram Drawing ---
    function drawSpectrogramColumn(dataArray) {
      if (!state.ctx) return;
      const w = state.canvas.width;
      const h = state.canvas.height;

      // 1. Shift existing
      state.tempCanvas.width = w;
      state.tempCanvas.height = h;
      state.tempCtx.drawImage(state.canvas, 0, 0);
      
      state.ctx.clearRect(0, 0, w, h);
      state.ctx.drawImage(state.tempCanvas, -1, 0);

      // 2. Draw new column
      const barH = h / dataArray.length;
      for (let i = 0; i < dataArray.length; i++) {
        const val = dataArray[i];
        const hue = 260 - (val / 255) * 200;
        const light = (val / 255) * 50;
        
        state.ctx.fillStyle = `hsl(${hue}, 100%, ${light}%)`;
        state.ctx.fillRect(w - 1, h - i * barH - barH, 2, barH + 1);
      }
    }

    function resizeCanvas() {
      if (state.canvas) {
        state.canvas.width = state.canvas.offsetWidth;
        state.canvas.height = state.canvas.offsetHeight;
      }
    }

    // --- Event Wiring ---
    function setupAudioListeners() {
      state.audioEl.addEventListener("play", () => updateUI(true));
      state.audioEl.addEventListener("pause", () => updateUI(false));
      state.audioEl.addEventListener("playing", () => ui.status.innerText = "Live Audio");
      state.audioEl.addEventListener("waiting", () => ui.status.innerText = "Buffering...");
      state.audioEl.addEventListener("error", () => {
        updateUI(false);
        ui.status.innerText = "Error";
      });
    }

    function setupUIListeners() {
      ui.playBtn.onclick = () => {
        if (state.audioEl.paused) startStream();
        else stopStream();
      };
      
      ui.vol.oninput = (e) => {
        const v = parseFloat(e.target.value);
        if (!isNaN(v)) state.audioEl.volume = v;
      };
    }

    function updateUI(isPlaying) {
      if (isPlaying) {
        ui.playIcon.classList.add("hidden");
        ui.pauseIcon.classList.remove("hidden");
        ui.playBtn.classList.replace("bg-purple-600", "bg-red-500");
        ui.playBtn.classList.replace("hover:bg-purple-700", "hover:bg-red-600");
      } else {
        ui.playIcon.classList.remove("hidden");
        ui.pauseIcon.classList.add("hidden");
        ui.playBtn.classList.replace("bg-red-500", "bg-purple-600");
        ui.playBtn.classList.replace("hover:bg-red-600", "hover:bg-purple-700");
      }
    }

    // Start
    init();

  })();
</script>
{% endblock %} {% block inspector %}
<!-- No inspector needed for live stream page -->
{% endblock %}
