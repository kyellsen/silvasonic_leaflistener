# ------------------------------------------------------------------------------
# POSTGRESQL CONFIGURATION FILE (Silvasonic Optimized)
# ------------------------------------------------------------------------------
# Customized for Raspberry Pi 5 (4GB - 16GB models) with NVMe Storage.
# Strategy: "Balanced Edge" - Safe for 4GB RAM, Performant for NVMe.

# ------------------------------------------------------------------------------
# CONNECTIONS
# ------------------------------------------------------------------------------
listen_addresses = '*'
max_connections = 100           # Sufficient for internal microservices

# ------------------------------------------------------------------------------
# MEMORY
# ------------------------------------------------------------------------------
# Shared Buffers: 512MB
# Rationale: 12% of 4GB RAM. Safe for base model, enables basic caching.
# On 16GB model, this is conservative but extremely fast compared to 128MB.
shared_buffers = 512MB

# Work Mem: 8MB
# Rationale: Default is 4MB. 8MB helps with dashboard sorts/hashes.
# Watch out: This is per-operation! 100 connections * 8MB could be 800MB (worst case).
work_mem = 8MB

# Maintenance Work Mem: 64MB
# Rationale: Faster index creation/vacuuming.
maintenance_work_mem = 64MB

# Effective Cache Size: 2GB
# Rationale: Hint to planner about OS file cache availability.
effective_cache_size = 2GB

# ------------------------------------------------------------------------------
# WRITE AHEAD LOG (WAL) & CHECKPOINTS
# ------------------------------------------------------------------------------
# Synchronous Commit: OFF
# Rationale: The "Turbo Button". Writes return success before hitting disk.
# RISK: ~500ms data loss on power cut.
# GAIN: Massive I/O reduction and CPU savings.
synchronous_commit = off

# WAL Buffers: 16MB
# Rationale: Default -1 (auto) is often too small. 16MB reduces WAL I/O.
wal_buffers = 16MB

# Checkpoint Timeout: 15min
# Rationale: Spread out writes. Default 5min is too aggressive for logging data.
checkpoint_timeout = 15min

# Checkpoint Completion Target: 0.9
# Rationale: Spread I/O over 90% of the checkpoint interval (smoother load).
checkpoint_completion_target = 0.9

# ------------------------------------------------------------------------------
# QUERY TUNING (NVMe OPTIMIZATIONS)
# ------------------------------------------------------------------------------
# Random Page Cost: 1.1
# Rationale: NVMe drives have negligible seek latency. Default is 4.0 (HDD).
# This tells the planner: "Index scans are cheap, use them!"
random_page_cost = 1.1

# Effective IO Concurrency: 200
# Rationale: NVMe can handle parallel I/O requests. Default is 1.
effective_io_concurrency = 200

# ------------------------------------------------------------------------------
# LOGGING
# ------------------------------------------------------------------------------
# Minimal logging to save disk space
log_min_duration_statement = 1000  # Log queries taking > 1s
log_checkpoints = on
log_connections = off
log_disconnections = off
log_lock_waits = on
log_timezone = 'UTC'
timezone = 'UTC'

# ------------------------------------------------------------------------------
# AUTOVACUUM
# ------------------------------------------------------------------------------
autovacuum = on
autovacuum_max_workers = 3
autovacuum_naptime = 1min
