---
- name: Silvasonic Base Setup
  hosts: all
  become: true
  vars:
    # Packages list
    # Packages list
    packages:
      - tree
      - git
      - btop
      - rsync
      - fzf
      - ripgrep
      - nano
      - syncthing
      - ncdu
      - tmux
      - usbutils
      - pciutils
      - sox
      - ffmpeg
      - stress
      - timg
      - podman
      - podman-compose
      - cockpit
      - cockpit-podman
      - python3-flask
    # Repository settings
    repo_url: "https://github.com/kyellsen/silvasonic.git"
    repo_dest: "/mnt/data/dev/silvasonic"
    # Unified Data Directory (Same for Pi and Dev Workstation)
    silvasonic_data_dir: "/mnt/data/dev_workspaces/silvasonic"

  tasks:
    # --- 1. SYSTEM UPDATE ---
    - name: System Update & Upgrade
      apt:
        update_cache: yes
        upgrade: dist
        autoremove: yes

    - name: Enable PCIe Gen 3 in config.txt
      lineinfile:
        path: /boot/firmware/config.txt
        regexp: "^dtparam=pciex1_gen=3"
        line: "dtparam=pciex1_gen=3"
        state: present
      notify: Reboot Required

    # --- 2. TOOLS INSTALLATION ---
    - name: Install Base Packages
      apt:
        name: "{{ packages }}"
        state: present

    - name: Install 'uv' (Python Tool)
      shell: "curl -LsSf https://astral.sh/uv/install.sh | sh"
      args:
        creates: "/root/.cargo/bin/uv"

    # --- 3. INFRASTRUCTURE & COCKPIT ---
    - name: Enable Cockpit Socket
      systemd:
        name: cockpit.socket
        state: started
        enabled: yes

    - name: Enable Podman Socket (System-Wide)
      systemd:
        name: podman.socket
        enabled: yes
        state: started

    # --- 3b. ROOTLESS PRE-REQUISITES ---
    - name: Allow unprivileged users to bind port 80 (for Caddy)
      sysctl:
        name: net.ipv4.ip_unprivileged_port_start
        value: "80"
        state: present
        reload: yes

    - name: Enable Linger for User (allows services to run without login)
      command: "loginctl enable-linger {{ user }}"
      args:
        creates: "/var/lib/systemd/linger/{{ user }}"

    - name: Add User to Hardware Groups
      user:
        name: "{{ user }}"
        groups: 
          - audio
          - plugdev
          - dialout
          - video
          - render
          - gpio
        append: yes

    # --- 4. SSD STRUCTURE ---
    - name: Create Directories on /mnt/data
      file:
        path: "{{ item }}"
        state: directory
        owner: "{{ user }}"
        group: "{{ user }}"
        mode: "0755"
      loop:
        - /mnt/data/dev
        - /mnt/data/containers
        - "{{ silvasonic_data_dir }}/logs"
        - "{{ silvasonic_data_dir }}/config"
        - "{{ silvasonic_data_dir }}/status"
        - "{{ silvasonic_data_dir }}/errors"
        - "{{ silvasonic_data_dir }}/notifications"
        - "{{ silvasonic_data_dir }}/recorder/recordings"
        - "{{ silvasonic_data_dir }}/uploader/config"
        - "{{ silvasonic_data_dir }}/birdnet/results"
        - "{{ silvasonic_data_dir }}/db/data"

    # Storage-Link Fix for Podman (ROOT-Level)
    # Critical: Since silvasonic.service runs as root, we must move root's storage to SSD
    - name: Prepare Root Podman Storage on SSD
      file:
        path: /mnt/data/containers-system
        state: directory
        mode: "0711" # Standard root execution path permissions

    - name: Check if /var/lib/containers is already a symlink
      stat:
        path: /var/lib/containers
      register: root_storage_stat

    - name: Migrate Root Podman Storage to SSD
      become: true
      shell: |
        systemctl stop silvasonic.service || true
        systemctl --user stop silvasonic.service || true
        systemctl stop podman.socket || true
        systemctl stop podman.service || true
        rsync -aAXv /var/lib/containers/ /mnt/data/containers-system/
        rm -rf /var/lib/containers
        ln -s /mnt/data/containers-system /var/lib/containers
        systemctl start podman.socket
      when: root_storage_stat.stat.islnk is not defined or root_storage_stat.stat.islnk == False
      # Basic safety check: only run if /var/lib/containers exists and is a directory
      # This is a bit "heavy", but safe for a one-time migration.

    # Storage-Link Fix for Podman (User-Level - for CLI debugging)
    - name: Link Podman Storage to SSD (for User)
      become: true
      become_user: "{{ user }}"
      shell: |
        podman system migrate 2>/dev/null || true
        rm -rf ~/.local/share/containers
        mkdir -p ~/.local/share
        ln -s /mnt/data/containers ~/.local/share/containers
      args:
        creates: "/home/{{ user }}/.local/share/containers/storage"

    - name: Ensure User Systemd Directory Exists
      file:
        path: "/home/{{ user }}/.config/systemd/user"
        state: directory
        owner: "{{ user }}"
        group: "{{ user }}"
        mode: "0755"

    # --- 5. CLONE REPOSITORY FROM GITHUB ---
    # --- 5. SYNC REPOSITORY FROM LOCALHOST ---
    - name: Sync Silvasonic Repository (Local -> Remote)
      become: true
      become_user: "{{ user }}"
      synchronize:
        src: "{{ local_repo_root }}/"
        dest: "{{ repo_dest }}"
        recursive: yes
        delete: yes
        rsync_opts:
          - "--exclude=.venv"
          # - "--exclude=.git/objects" # Full sync requested
          - "--exclude=__pycache__"
          - "--exclude=*.pyc"
          - "--exclude=.pytest_cache"
          - "--exclude=.ruff_cache"
          - "--exclude=recordings" # Don't sync local recordings if they exist
      tags: [repo]

    - name: Configure Git Remote for Public Access (HTTPS)
      become: true
      become_user: "{{ user }}"
      shell: "git remote set-url origin {{ repo_url }}"
      args:
        chdir: "{{ repo_dest }}"
      tags: [repo]

    # --- 6. COPY HELPER SCRIPTS ---
    - name: Copy Hardware Verification Script
      copy:
        src: "{{ repo_dest }}/scripts/verify_hardware.sh"
        dest: "/home/{{ user }}/verify_hardware.sh"
        owner: "{{ user }}"
        group: "{{ user }}"
        mode: "0755"
        remote_src: yes
      tags: [tools, health]

    - name: Copy Audio Verification Script
      copy:
        src: "{{ repo_dest }}/scripts/verify_audio.sh"
        dest: "/home/{{ user }}/verify_audio.sh"
        owner: "{{ user }}"
        group: "{{ user }}"
        mode: "0755"
        remote_src: yes
      tags: [tools, audio]

    # --- 7. SERVICE INSTALLATION ---
    - name: Install Silvasonic User Service
      copy:
        src: "{{ repo_dest }}/setup/config/silvasonic.service"
        dest: "/home/{{ user }}/.config/systemd/user/silvasonic.service"
        owner: "{{ user }}"
        group: "{{ user }}"
        mode: "0644"
        remote_src: yes
      notify: Reload Systemd User

    - name: Enable Silvasonic User Service
      become: true
      become_user: "{{ user }}"
      systemd:
        name: silvasonic.service
        scope: user
        enabled: yes
        state: started
        daemon_reload: yes

    # --- 8. WIFI BOOTSTRAP INSTALLATION ---
    - name: Create WiFi Bootstrap Directory
      file:
        path: /opt/silvasonic-wifi
        state: directory
        mode: "0755"

    - name: Copy WiFi Bootstrap Scripts
      copy:
        src: "{{ repo_dest }}/setup/wifi-connect/"
        dest: "/opt/silvasonic-wifi/"
        owner: root
        group: root
        mode: "0755"
        remote_src: yes
      tags: [wifi]

    - name: Install WiFi Bootstrap Service
      copy:
        src: "{{ repo_dest }}/setup/config/silvasonic-wifi.service"
        dest: "/etc/systemd/system/silvasonic-wifi.service"
        mode: "0644"
        remote_src: yes
      notify: Reload Systemd

    - name: Enable WiFi Bootstrap Service
      systemd:
        name: silvasonic-wifi
        enabled: yes
        state: started
        daemon_reload: yes

  handlers:
    - name: Reload Systemd
      systemd:
        daemon_reload: yes

    - name: Reload Systemd User
      become: true
      become_user: "{{ user }}"
      systemd:
        scope: user
        daemon_reload: yes

    - name: Reboot Required
      debug:
        msg: "A reboot is required (e.g. for PCIe Gen3 Config or Kernel updates)."
