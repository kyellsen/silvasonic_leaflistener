---
- name: Silvasonic Base Setup
  hosts: all
  become: true
  vars:
    # Packages list
    packages:
      - tree
      - git
      - btop
      - rsync
      - fzf
      - ripgrep
      - nano
      - syncthing
      - ncdu
      - tmux
      - usbutils
      - pciutils
      - sox
      - ffmpeg
      - stress
      - timg
      - podman
      - podman-compose
      - cockpit
      - cockpit-podman
      - python3-venv
      - python3-pip
    # Repository settings
    repo_url: "https://github.com/kyellsen/silvasonic_leaflistener.git"
    repo_dest: "/mnt/data/dev/silvasonic"

  tasks:
    # --- 1. SYSTEM UPDATE ---
    - name: System Update & Upgrade
      apt:
        update_cache: yes
        upgrade: dist
        autoremove: yes

    - name: Enable PCIe Gen 3 in config.txt
      lineinfile:
        path: /boot/firmware/config.txt
        regexp: "^dtparam=pciex1_gen=3"
        line: "dtparam=pciex1_gen=3"
        state: present
      notify: Reboot Required

    # --- 2. TOOLS INSTALLATION ---
    - name: Install Base Packages
      apt:
        name: "{{ packages }}"
        state: present

    - name: Install 'uv' (Python Tool)
      shell: "curl -LsSf https://astral.sh/uv/install.sh | sh"
      args:
        creates: "/root/.cargo/bin/uv"

    # --- 3. INFRASTRUCTURE & COCKPIT ---
    - name: Enable Cockpit Socket
      systemd:
        name: cockpit.socket
        state: started
        enabled: yes

    - name: Add User to 'audio' and 'docker'/'podman' related groups if needed
      user:
        name: "{{ user }}"
        groups: audio
        append: yes

    # --- 4. SSD STRUCTURE ---
    - name: Create Directories on /mnt/data
      file:
        path: "{{ item }}"
        state: directory
        owner: "{{ user }}"
        group: "{{ user }}"
        mode: "0755"
      loop:
        - /mnt/data/dev
        - /mnt/data/containers
        - /mnt/data/services/silvasonic/recordings
        - /mnt/data/services/silvasonic/logs
        - /mnt/data/services/silvasonic/config
        - /mnt/data/services/silvasonic/brain
        - /mnt/data/services/silvasonic/birdnet
        - /mnt/data/services/silvasonic/carrier
        - /mnt/data/backups

    # Storage-Link Fix for Podman (User-Level)
    - name: Link Podman Storage to SSD (for User)
      become: true
      become_user: "{{ user }}"
      shell: |
        podman system migrate 2>/dev/null || true
        rm -rf ~/.local/share/containers
        mkdir -p ~/.local/share
        ln -s /mnt/data/containers ~/.local/share/containers
      args:
        creates: "/home/{{ user }}/.local/share/containers/storage"

    # --- 5. CLONE REPOSITORY FROM GITHUB ---
    - name: Clone Silvasonic Repository
      become: true
      become_user: "{{ user }}"
      git:
        repo: "{{ repo_url }}"
        dest: "{{ repo_dest }}"
        version: main
        update: yes
      tags: [repo]

    # --- 6. COPY HELPER SCRIPTS ---
    - name: Copy Health Check Script
      copy:
        src: "{{ repo_dest }}/scripts/check.sh"
        dest: "/home/{{ user }}/check.sh"
        owner: "{{ user }}"
        group: "{{ user }}"
        mode: "0755"
        remote_src: yes
      tags: [tools, health]

    - name: Copy Sound-Lab Script
      copy:
        src: "{{ repo_dest }}/scripts/sound_check.sh"
        dest: "/home/{{ user }}/sound_check.sh"
        owner: "{{ user }}"
        group: "{{ user }}"
        mode: "0755"
        remote_src: yes
      tags: [tools, audio]

    # --- 7. SERVICE INSTALLATION ---
    - name: Install Silvasonic Service
      copy:
        src: "{{ repo_dest }}/setup/config/silvasonic.service"
        dest: "/etc/systemd/system/silvasonic.service"
        owner: root
        group: root
        mode: "0644"
        remote_src: yes
      notify: Reload Systemd

    - name: Enable & Start Silvasonic Service
      systemd:
        name: silvasonic
        enabled: yes
        state: started
        daemon_reload: yes

  handlers:
    - name: Reload Systemd
      systemd:
        daemon_reload: yes

    - name: Reboot Required
      debug:
        msg: "A reboot is required (e.g. for PCIe Gen3 Config or Kernel updates)."
